<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>12月東京快閃 | Tokyo Trip</title>
    
    <!-- Google Fonts: Noto Sans TC -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Tailwind Configuration for Muji Style -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        muji: {
                            bg: '#f7f7f7',      // 淺灰背景
                            paper: '#ffffff',   // 純白卡片
                            text: '#333333',    // 深灰文字
                            sub: '#7a7a7a',     // 次要文字
                            accent: '#7f5539',  // 棕色強調 (木頭感)
                            highlight: '#b08968', // 淺棕
                            danger: '#ef4444',  // 警示紅
                            success: '#598a68'  // 抹茶綠
                        }
                    },
                    fontFamily: {
                        sans: ['"Noto Sans TC"', 'sans-serif'],
                    }
                }
            }
        }
    </script>

    <style>
        body {
            background-color: #f7f7f7;
            font-family: 'Noto Sans TC', sans-serif;
            -webkit-tap-highlight-color: transparent;
            padding-bottom: 80px; /* Space for bottom nav */
        }
        
        /* Hide scrollbar for clean look */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.3s ease-in-out;
        }
        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* IOS Input Fix */
        input, textarea {
            font-size: 16px !important; 
        }

        /* Custom style for the large image modal background */
        #image-modal {
            transition: opacity 0.3s ease-in-out;
            opacity: 0;
            pointer-events: none;
        }
        #image-modal.active {
            opacity: 1;
            pointer-events: auto;
        }
    </style>
</head>
<body class="text-muji-text">

    <!-- Header -->
    <header class="fixed top-0 w-full bg-muji-paper/90 backdrop-blur-md shadow-sm z-50 px-4 py-3 flex justify-between items-center">
        <div>
            <h1 class="text-lg font-bold tracking-widest text-muji-accent">TOKYO TRIP</h1>
            <p class="text-xs text-muji-sub">12.11 - 12.14</p>
        </div>
        <div id="weather-badge" class="bg-gray-100 px-2 py-1 rounded text-xs text-muji-sub">
            <i class="fas fa-cloud"></i> 東京
        </div>
    </header>

    <!-- Main Content Area -->
    <main class="mt-16 px-4">

        <!-- SECTION: PLAN -->
        <div id="view-plan" class="tab-content active">
            <div class="flex space-x-2 mb-4 sticky top-16 bg-muji-bg z-40 py-2 overflow-x-auto no-scrollbar">
                <button onclick="switchDay('d1', event)" id="btn-d1" class="day-btn flex-shrink-0 px-6 py-2 rounded-full bg-muji-accent text-white text-sm font-medium transition-all shadow-md">
                    D1 (12/11)
                </button>
                <button onclick="switchDay('d2', event)" id="btn-d2" class="day-btn flex-shrink-0 px-6 py-2 rounded-full bg-white text-muji-sub text-sm font-medium transition-all border border-gray-200">
                    D2 (12/12)
                </button>
                <button onclick="switchDay('d3', event)" id="btn-d3" class="day-btn flex-shrink-0 px-6 py-2 rounded-full bg-white text-muji-sub text-sm font-medium transition-all border border-gray-200">
                    D3+ 返程
                </button>
            </div>

            <!-- Day 1 Content -->
            <div id="content-d1" class="day-content space-y-4">
                <!-- Timeline Items generated by JS -->
            </div>
            
            <!-- Day 2 Content -->
            <div id="content-d2" class="day-content space-y-4 hidden">
                <!-- Timeline Items generated by JS -->
            </div>

             <!-- Day 3 Content -->
             <div id="content-d3" class="day-content space-y-4 hidden">
                <div class="bg-white p-4 rounded-xl shadow-sm border-l-4 border-muji-accent">
                    <div class="flex justify-between items-start">
                        <span class="text-xl font-bold text-muji-accent">01:55</span>
                        <span class="bg-gray-100 text-xs px-2 py-1 rounded">12/14 (六)</span>
                    </div>
                    <h3 class="font-bold text-lg mt-1">返程航班 UO629</h3>
                    <p class="text-sm text-muji-sub mt-1">HND 羽田機場 → HKG 香港</p>
                    <div class="mt-3 text-sm bg-gray-50 p-2 rounded">
                        抵達香港時間：06:15
                    </div>
                </div>
            </div>
        </div>

        <!-- SECTION: GUIDE -->
        <div id="view-guide" class="tab-content">
            <h2 class="text-xl font-bold text-muji-accent mb-4 border-b pb-2">深度導覽</h2>
            <div id="guide-container" class="space-y-6">
                <!-- Guide Cards generated by JS -->
            </div>
        </div>

        <!-- SECTION: WALLET -->
        <div id="view-wallet" class="tab-content">
            <!-- Rate Calculator -->
            <div class="bg-muji-paper p-4 rounded-xl shadow-sm mb-6">
                <div class="flex justify-between items-center mb-2">
                    <h3 class="font-bold text-muji-accent"><i class="fas fa-calculator mr-1"></i> 匯率計算機</h3>
                    <div class="text-xs text-muji-sub">
                        匯率 (HKD/JPY): <input type="number" id="exchange-rate" value="0.052" class="w-20 border rounded text-center ml-1 focus:outline-none focus:border-muji-accent" step="0.001">
                    </div>
                </div>
                <div class="bg-gray-100 p-3 rounded-lg mb-3">
                    <input type="text" id="calc-input" placeholder="輸入算式 (如 1000+500)" class="w-full bg-transparent text-xl font-mono text-right outline-none placeholder-gray-400" oninput="calculate()">
                    <div class="flex justify-between items-end mt-1">
                        <span class="text-xs text-gray-500">總金額 (JPY): <span id="calc-result-jpy" class="font-mono">0</span></span>
                        <span class="text-2xl font-bold text-muji-accent">HK$ <span id="calc-result-hkd">0.0</span></span>
                    </div>
                </div>
                <div class="grid grid-cols-4 gap-2">
                    <button onclick="appendCalc('7')" class="p-3 bg-gray-50 rounded shadow-sm text-lg">7</button>
                    <button onclick="appendCalc('8')" class="p-3 bg-gray-50 rounded shadow-sm text-lg">8</button>
                    <button onclick="appendCalc('9')" class="p-3 bg-gray-50 rounded shadow-sm text-lg">9</button>
                    <button onclick="appendCalc('/')" class="p-3 bg-gray-200 rounded shadow-sm text-lg text-muji-accent">÷</button>
                    
                    <button onclick="appendCalc('4')" class="p-3 bg-gray-50 rounded shadow-sm text-lg">4</button>
                    <button onclick="appendCalc('5')" class="p-3 bg-gray-50 rounded shadow-sm text-lg">5</button>
                    <button onclick="appendCalc('6')" class="p-3 bg-gray-50 rounded shadow-sm text-lg">6</button>
                    <button onclick="appendCalc('*')" class="p-3 bg-gray-200 rounded shadow-sm text-lg text-muji-accent">×</button>
                    
                    <button onclick="appendCalc('1')" class="p-3 bg-gray-50 rounded shadow-sm text-lg">1</button>
                    <button onclick="appendCalc('2')" class="p-3 bg-gray-50 rounded shadow-sm text-lg">2</button>
                    <button onclick="appendCalc('3')" class="p-3 bg-gray-50 rounded shadow-sm text-lg">3</button>
                    <button onclick="appendCalc('-')" class="p-3 bg-gray-200 rounded shadow-sm text-lg text-muji-accent">-</button>
                    
                    <button onclick="appendCalc('0')" class="p-3 bg-gray-50 rounded shadow-sm text-lg">0</button>
                    <button onclick="clearCalc()" class="p-3 text-red-500 bg-red-50 rounded shadow-sm text-lg">C</button>
                    <button onclick="calculate('=')" class="p-3 bg-muji-accent text-white rounded shadow-sm text-lg font-bold">=</button>
                    <button onclick="appendCalc('+')" class="p-3 bg-gray-200 rounded shadow-sm text-lg text-muji-accent">+</button>
                </div>
            </div>

            <!-- Expense Tracker -->
            <div class="mb-4 flex justify-between items-center">
                <h3 class="font-bold text-lg">記帳與回憶</h3>
                <span class="text-sm text-muji-sub">總計: <span id="total-expense" class="font-bold">0</span> JPY</span>
            </div>

            <!-- Add New Expense -->
            <div class="bg-white p-4 rounded-xl shadow-sm mb-4">
                <div class="flex gap-2 mb-2">
                    <input type="text" id="expense-item" placeholder="品項 (如: 拉麵)" class="flex-1 border-b border-gray-200 p-2 outline-none">
                    <input type="number" id="expense-amount" placeholder="金額 (JPY)" class="w-28 border-b border-gray-200 p-2 outline-none">
                </div>
                <div class="flex justify-between items-center mt-3">
                    <label class="flex items-center gap-2 text-sm text-muji-sub cursor-pointer bg-gray-50 px-3 py-2 rounded-lg">
                        <i class="fas fa-camera"></i> 上傳照片
                        <input type="file" id="expense-photo" accept="image/*" class="hidden" onchange="handlePhotoSelect(this)">
                    </label>
                    <span id="photo-preview-text" class="text-xs text-gray-400">未選擇</span>
                    <button onclick="addExpense()" class="bg-muji-accent text-white px-4 py-2 rounded-lg text-sm shadow-md hover:opacity-90">
                        新增
                    </button>
                </div>
            </div>

            <!-- Expense List -->
            <div id="expense-list" class="space-y-3 pb-4">
                <!-- Expense items generated by JS -->
            </div>
        </div>

        <!-- SECTION: LISTS -->
        <div id="view-lists" class="tab-content">
            <!-- Checklist -->
            <div class="bg-white p-5 rounded-xl shadow-sm mb-6">
                <h3 class="font-bold text-muji-accent mb-3 border-b pb-2">行前準備 CheckList</h3>
                <div class="space-y-2" id="checklist-container">
                    <!-- Checkboxes generated by JS -->
                </div>
                <div class="mt-4 flex gap-2">
                    <input type="text" id="new-todo" placeholder="新增待辦..." class="flex-1 bg-gray-50 rounded px-3 py-2 text-sm outline-none">
                    <button onclick="addTodo()" class="text-muji-accent font-bold px-2 py-1 rounded-full border border-muji-accent hover:bg-muji-accent hover:text-white transition">+</button>
                </div>
            </div>

            <!-- Memo -->
            <div class="bg-white p-5 rounded-xl shadow-sm">
                <h3 class="font-bold text-muji-accent mb-3 border-b pb-2">個人備忘錄</h3>
                <p class="text-xs text-gray-400 mb-2">輸入網址會自動轉換為連結按鈕</p>
                <textarea id="memo-area" class="w-full h-40 bg-gray-50 p-3 rounded-lg text-sm resize-none outline-none focus:ring-1 focus:ring-muji-accent" placeholder="在這裡輸入筆記、訂位代號或網址..."></textarea>
                <div id="memo-links" class="mt-3 flex flex-wrap gap-2"></div>
            </div>
        </div>

        <!-- SECTION: INFO -->
        <div id="view-info" class="tab-content">
            <!-- Emergency -->
            <div class="bg-red-50 p-4 rounded-xl border border-red-100 mb-4">
                <h3 class="font-bold text-red-800 mb-2"><i class="fas fa-exclamation-circle"></i> 緊急聯絡</h3>
                <ul class="text-sm text-red-700 space-y-1">
                    <li>警察局: 110</li>
                    <li>火警/救護車: 119</li>
                    <li>外交部旅外急難救助: +81-80-1009-7179</li>
                </ul>
            </div>

            <!-- Hotel Info -->
            <div class="bg-white p-4 rounded-xl shadow-sm mb-4">
                <h3 class="font-bold text-muji-accent mb-2"><i class="fas fa-hotel"></i> 住宿資訊</h3>
                <p class="font-bold">天然温泉 豊穣の湯 ドーミーイン池袋</p>
                <p class="text-sm text-muji-sub">Dormy Inn Ikebukuro</p>
                <div class="mt-3 flex gap-2">
                    <a href="https://www.google.com/maps/search/?api=1&query=Dormy+Inn+Ikebukuro" target="_blank" class="flex-1 bg-gray-100 text-center py-2 rounded text-sm text-muji-text hover:bg-gray-200">
                        <i class="fas fa-map-marker-alt"></i> 地圖
                    </a>
                </div>
            </div>

            <!-- Flight Info -->
            <div class="bg-white p-4 rounded-xl shadow-sm mb-4">
                <h3 class="font-bold text-muji-accent mb-2"><i class="fas fa-plane"></i> 航班資訊</h3>
                <div class="text-sm space-y-3">
                    <div class="border-l-2 border-muji-accent pl-3">
                        <p class="font-bold">去程: UO624</p>
                        <p>12/10 23:55 HKG → 12/11 04:45 HND</p>
                    </div>
                    <div class="border-l-2 border-muji-accent pl-3">
                        <p class="font-bold">回程: UO629</p>
                        <p>12/14 01:55 HND → 12/14 06:15 HKG</p>
                    </div>
                </div>
            </div>
            
            <!-- Useful Links -->
            <div class="bg-white p-4 rounded-xl shadow-sm">
                 <h3 class="font-bold text-muji-accent mb-2"><i class="fas fa-link"></i> 實用連結</h3>
                 <div class="grid grid-cols-2 gap-3">
                     <a href="https://www.jma.go.jp/bosai/forecast/" target="_blank" class="block bg-blue-50 text-blue-700 p-3 rounded text-center text-sm font-medium">
                        <i class="fas fa-sun"></i> 日本氣象廳
                     </a>
                     <a href="https://transit.yahoo.co.jp/" target="_blank" class="block bg-green-50 text-green-700 p-3 rounded text-center text-sm font-medium">
                        <i class="fas fa-subway"></i> 乘換案內
                     </a>
                 </div>
                 <div class="mt-4 border-t pt-3">
                    <h4 class="font-bold text-muji-sub text-sm mb-2">旅遊注意事項/禁忌</h4>
                    <ul class="list-disc list-inside text-xs text-gray-600 space-y-1">
                        <li>日本地鐵/電車內請勿通話，手機改為靜音模式。</li>
                        <li>部分餐廳不接受「兩人共食一份餐點」。</li>
                        <li>入境違禁品：請務必避免攜帶大量或未經申報的藥品/肉製品/新鮮水果。</li>
                    </ul>
                 </div>
            </div>
        </div>

    </main>

    <!-- Bottom Navigation -->
    <nav class="fixed bottom-0 w-full bg-white border-t border-gray-200 flex justify-around items-center py-2 pb-5 z-50 text-xs text-gray-400">
        <button onclick="switchTab('view-plan', event)" class="nav-btn active flex flex-col items-center w-full space-y-1 text-muji-accent font-medium">
            <i class="fas fa-calendar-alt text-lg"></i>
            <span>行程</span>
        </button>
        <button onclick="switchTab('view-guide', event)" class="nav-btn flex flex-col items-center w-full space-y-1">
            <i class="fas fa-book-open text-lg"></i>
            <span>導覽</span>
        </button>
        <button onclick="switchTab('view-wallet', event)" class="nav-btn flex flex-col items-center w-full space-y-1">
            <i class="fas fa-wallet text-lg"></i>
            <span>記帳</span>
        </button>
        <button onclick="switchTab('view-lists', event)" class="nav-btn flex flex-col items-center w-full space-y-1">
            <i class="fas fa-list-check text-lg"></i>
            <span>清單</span>
        </button>
        <button onclick="switchTab('view-info', event)" class="nav-btn flex flex-col items-center w-full space-y-1">
            <i class="fas fa-info-circle text-lg"></i>
            <span>資訊</span>
        </button>
    </nav>

    <!-- Modal for Full Image -->
    <div id="image-modal" class="fixed inset-0 bg-black/90 z-[60] flex items-center justify-center p-4" onclick="this.classList.remove('active')" role="dialog" aria-modal="true" aria-labelledby="modal-title">
        <h2 id="modal-title" class="sr-only">費用照片</h2>
        <img id="modal-img" src="" class="max-w-full max-h-full rounded-lg shadow-2xl" onclick="event.stopPropagation()">
    </div>

    <script>
        // --- DATA ---
        const d1Data = [
            { time: "04:45 - 08:30", action: "HND抵達、梳洗、寄放行李", location: "Dormy Inn Ikebukuro", note: "巴士前往池袋" },
            { time: "08:30 - 09:00", action: "輕食早餐", location: "池袋周邊", note: "" },
            { time: "09:00 - 09:30", action: "前往皇居", location: "池袋 → 大手町", note: "" },
            { time: "09:30 - 10:30", action: "[目標] 購買皇居長夾", location: "皇居東御苑 大手休憩所", note: "必買重點", highlight: true, link: "https://www.google.com/maps/search/?api=1&query=皇居東御苑" },
            { time: "10:30 - 11:00", action: "前往 BUTTER & 排隊", location: "東京車站 新丸大廈 B1F", note: "11:00 準時入店", highlight: true },
            { time: "11:00 - 12:00", action: "早午餐：BUTTER 美瑛放牧酪農場", location: "BUTTER 丸之內店", link: "https://www.google.com/maps/search/?api=1&query=BUTTER+Marunouchi" },
            { time: "12:00 - 12:45", action: "[目標] 購買 Suica 企鵝商品", location: "東京車站 PENSTA", note: "可愛周邊", link: "https://www.google.com/maps/search/?api=1&query=PENSTA" },
            { time: "12:45 - 13:15", action: "前往東京巨蛋城", location: "東京站 → 後樂園站", note: "" },
            { time: "13:15 - 13:45", action: "午餐：Soup Stock Tokyo", location: "LaQua 內", note: "快速享用", link: "https://www.google.com/maps/search/?api=1&query=Soup+Stock+Tokyo+LaQua" },
            { time: "13:45 - 17:45", action: "[參觀] Gallery AaMo 展覽 (1)", location: "Gallery AaMo", note: "第一次參觀", link: "https://www.tokyo-dome.co.jp/aamo/" },
            { time: "17:45 - 18:30", action: "返回池袋 & Check-in", location: "Dormy Inn", note: "放戰利品" },
            { time: "18:30 之後", action: "晚餐與休息", location: "池袋周邊", note: "自由活動" }
        ];

        const d2Data = [
            { time: "09:30 - 10:00", action: "早餐與出發", location: "飯店周邊", note: "10:00 準時出發", highlight: true },
            { time: "10:00 - 11:00", action: "前往東京巨蛋城", location: "池袋 → 後樂園", note: "" },
            { time: "11:00 - 14:00", action: "[參觀] Gallery AaMo 展覽 (2)", location: "Gallery AaMo", note: "第二次參觀，預計3小時", link: "https://www.google.com/maps/search/?api=1&query=Gallery+AaMo" },
            { time: "14:00 - 15:30", action: "午餐：つるとんたん 烏龍麵", location: "Meets Port 2F", note: "備案: B1F美食區", link: "https://www.google.com/maps/search/?api=1&query=つるとんたん" },
            { time: "15:30 - 16:15", action: "前往六本木區域", location: "後樂園 → 六本木", note: "" },
            { time: "16:15 - 18:30", action: "[紅葉/夜景] 自由活動", location: "六本木之丘 / 東京中城", note: "冬季點燈、逛街", link: "https://www.roppongihills.com/" },
            { time: "18:30 - 19:00", action: "返回池袋", location: "六本木 → 池袋", note: "" },
            { time: "19:00 之後", action: "[目標] Workman 購物", location: "池袋太陽城 Workman Plus", note: "晚餐在周邊解決", link: "https://www.google.com/maps/search/?api=1&query=Workman+Plus+池袋" }
        ];

        const guideData = [
            {
                title: "皇居東御苑 & 大手門",
                desc: "皇居是日本天皇居住的地方，前身為德川幕府的江戶城。東御苑是對外開放的區域，可以看到壯觀的石牆與歷史遺跡。「皇居長夾」因為是宮內廳生協所販售，皆為真皮且價格實惠，印有代表皇室的菊花紋章，成為知名的限定伴手禮。",
                tags: ["歷史", "購物"],
                map: { center: '35.6851,139.7533', zoom: 14 } // Imperial Palace
            },
            {
                title: "Gallery AaMo (東京巨蛋城)",
                desc: "位於東京巨蛋城的 Gallery AaMo 是一個融合「Art」與「Amusement」的藝廊。此次行程安排兩次參觀，顯示展覽內容相當豐富或有特定場次需求。周邊的 LaQua 是結合溫泉與購物的複合設施。",
                tags: ["藝術", "娛樂"],
                map: { center: '35.7058,139.7523', zoom: 15 } // Gallery AaMo
            },
            {
                title: "六本木之丘 (Roppongi Hills)",
                desc: "六本木是東京著名的藝術三角之一，森美術館與展望台 (Tokyo City View) 擁有絕佳的東京鐵塔夜景。12月時，櫸坂 (Keyakizaka) 會有著名的銀白藍色聖誕點燈，非常浪漫，是欣賞冬季東京夜景的必去之地。",
                tags: ["夜景", "聖誕點燈"],
                map: { center: '35.6603,139.7294', zoom: 15 } // Roppongi Hills
            }
        ];

        const defaultTodos = ["護照", "日幣現金", "信用卡 (確認海外開通)", "網卡/漫遊", "行動電源", "個人藥品", "雨具", "轉接頭/充電器"];

        // --- APP STATE ---
        // 使用 try-catch 確保 localStorage 訪問失敗時不會崩潰
        function getLocalItem(key, defaultValue) {
            try {
                const item = localStorage.getItem(key);
                return item ? JSON.parse(item) : defaultValue;
            } catch (e) {
                console.error(`Error reading localStorage key "${key}":`, e);
                return defaultValue;
            }
        }

        function setLocalItem(key, value) {
            try {
                localStorage.setItem(key, JSON.stringify(value));
            } catch (e) {
                console.error(`Error writing localStorage key "${key}":`, e);
                alert('您的瀏覽器不支援本地儲存功能，記帳資料將無法保存！');
            }
        }

        let expenses = getLocalItem('tokyo_expenses', []);
        let todos = getLocalItem('tokyo_todos', defaultTodos.map(item => ({ text: item, done: false })));
        let memo = localStorage.getItem('tokyo_memo') || "";
        let currentRate = parseFloat(localStorage.getItem('tokyo_rate')) || 0.052;

        // --- INIT ---
        document.addEventListener('DOMContentLoaded', () => {
            renderPlan('d1', d1Data);
            renderPlan('d2', d2Data);
            renderGuide();
            renderExpenses();
            renderTodos();
            
            // Set saved rate
            document.getElementById('exchange-rate').value = currentRate;
            
            // Set saved memo
            const memoArea = document.getElementById('memo-area');
            memoArea.value = memo;
            updateMemoLinks(memo);

            // Memo Listener
            memoArea.addEventListener('input', (e) => {
                localStorage.setItem('tokyo_memo', e.target.value);
                updateMemoLinks(e.target.value);
            });

            // Rate Listener
            document.getElementById('exchange-rate').addEventListener('input', (e) => {
                const newRate = parseFloat(e.target.value);
                if (!isNaN(newRate) && newRate > 0) {
                    currentRate = newRate;
                    localStorage.setItem('tokyo_rate', currentRate);
                    renderExpenses(); // Update display values
                    calculate('='); // Recalculate if there's input
                }
            });
            
            // Ensure first tab is active on load
            switchTab('view-plan', { currentTarget: document.querySelector('.nav-btn.active') });
        });

        // --- NAVIGATION ---
        function switchTab(tabId, event) {
            // Hide all contents
            document.querySelectorAll('.tab-content').forEach(el => {
                el.classList.remove('active');
            });
            // Show target
            document.getElementById(tabId).classList.add('active');

            // Update Nav Icons
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('text-muji-accent', 'font-medium');
                btn.classList.add('text-gray-400');
            });
            if (event && event.currentTarget) {
                event.currentTarget.classList.add('text-muji-accent', 'font-medium');
                event.currentTarget.classList.remove('text-gray-400');
            }
            
            window.scrollTo(0,0);
        }

        function switchDay(day, event) {
            document.querySelectorAll('.day-content').forEach(el => el.classList.add('hidden'));
            document.getElementById(`content-${day}`).classList.remove('hidden');
            
            document.querySelectorAll('.day-btn').forEach(btn => {
                btn.classList.remove('bg-muji-accent', 'text-white');
                btn.classList.add('bg-white', 'text-muji-sub', 'border');
            });
            
            if (event && event.currentTarget) {
                const activeBtn = event.currentTarget;
                activeBtn.classList.remove('bg-white', 'text-muji-sub', 'border');
                activeBtn.classList.add('bg-muji-accent', 'text-white');
            }
        }

        // --- RENDER FUNCTIONS ---
        function renderPlan(dayId, data) {
            const container = document.getElementById(`content-${dayId}`);
            if (!container) return;
            let html = '';
            
            data.forEach(item => {
                const borderClass = item.highlight ? 'border-l-4 border-muji-accent bg-orange-50' : 'border-l-2 border-gray-200 bg-white';
                const timeClass = item.highlight ? 'text-muji-accent font-bold' : 'text-gray-500 font-medium';
                
                let linkBtn = '';
                if(item.link) {
                    linkBtn = `<a href="${item.link}" target="_blank" class="ml-2 text-muji-accent text-sm font-normal underline hover:no-underline">食記/地圖</a>`;
                }

                html += `
                <div class="${borderClass} p-4 rounded-r-xl shadow-sm relative">
                    <div class="flex justify-between items-start mb-1">
                        <span class="${timeClass} text-sm bg-white/50 px-2 rounded">${item.time}</span>
                    </div>
                    <h4 class="font-bold text-lg text-muji-text leading-tight">${item.action}</h4>
                    <div class="flex items-center text-sm text-muji-sub mt-2">
                        <i class="fas fa-location-arrow mr-2 text-xs"></i>
                        <span>${item.location}</span>
                    </div>
                    ${item.note ? `<p class="text-xs text-gray-400 mt-2 bg-gray-50 inline-block px-2 py-1 rounded">${item.note}</p>` : ''}
                    ${linkBtn}
                </div>`;
            });
            container.innerHTML = html;
        }

        function renderGuide() {
            const container = document.getElementById('guide-container');
            let html = '';
            guideData.forEach(item => {
                // OpenStreetMap iframe code using standard parameters for better compatibility
                const mapIframe = `
                    <iframe 
                        width="100%" 
                        height="100%" 
                        frameborder="0" 
                        scrolling="no" 
                        marginheight="0" 
                        marginwidth="0" 
                        src="https://www.openstreetmap.org/export/embed.html?bbox=139.70,35.65,139.80,35.75&amp;layer=mapnik&amp;marker=${item.map.center}"
                        style="border: 1px solid #ccc; pointer-events: none; display: block;">
                    </iframe>
                `;

                html += `
                <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                    <div class="h-40 bg-gray-200 relative overflow-hidden">
                         ${mapIframe}
                         <div class="absolute inset-0 bg-gradient-to-t from-black/50 to-transparent flex items-end p-4">
                            <h3 class="text-white font-bold text-xl text-shadow">${item.title}</h3>
                         </div>
                    </div>
                    <div class="p-4">
                        <div class="flex gap-2 mb-3 flex-wrap">
                            ${item.tags.map(t => `<span class="text-xs bg-gray-100 text-gray-600 px-2 py-1 rounded">${t}</span>`).join('')}
                        </div>
                        <p class="text-sm text-gray-600 leading-relaxed text-justify">${item.desc}</p>
                        <a href="https://www.google.com/maps/search/?api=1&query=${item.title}" target="_blank" class="block mt-4 text-center text-muji-accent text-sm font-bold border border-muji-accent rounded py-2 hover:bg-muji-accent hover:text-white transition">
                            開啟 Google Maps
                        </a>
                    </div>
                </div>`;
            });
            container.innerHTML = html;
        }

        // --- CALCULATOR LOGIC (Security Fix: Replaced eval with a safer parser) ---
        function appendCalc(val) {
            const input = document.getElementById('calc-input');
            input.value += val;
            calculate();
        }

        function clearCalc() {
            document.getElementById('calc-input').value = "";
            document.getElementById('calc-result-jpy').innerText = "0";
            document.getElementById('calc-result-hkd').innerText = "0.0";
        }

        // Safe calculation logic (handles +, -, *, / but avoids eval)
        function performSafeCalculation(expression) {
            // Clean expression: remove non-math characters and replace common multiplication symbols
            let cleanExpr = expression.replace(/[^0-9+\-*/.]/g, '');
            if (!cleanExpr) return 0;
            
            // Standard order of operations (PEMDAS/BODMAS) is complex to implement fully without eval
            // For a simple calculator, we'll try to find the result sequentially for simplicity, 
            // but the user expects it to follow basic math rules.
            
            // For a production-level app, you'd use a parser library. 
            // Here, we use a simple approach: force all operations to be executed sequentially after replacing operators.
            
            try {
                // A very basic calculator implementation:
                const parts = cleanExpr.match(/(\d+\.?\d*)|[+\-*/]/g);
                if (!parts || parts.length === 0) return 0;

                let currentResult = parseFloat(parts[0]);
                for (let i = 1; i < parts.length; i += 2) {
                    const operator = parts[i];
                    const operand = parseFloat(parts[i + 1]);

                    if (isNaN(operand)) continue;

                    switch (operator) {
                        case '+':
                            currentResult += operand;
                            break;
                        case '-':
                            currentResult -= operand;
                            break;
                        case '*':
                            currentResult *= operand;
                            break;
                        case '/':
                            if (operand === 0) throw new Error("Division by zero");
                            currentResult /= operand;
                            break;
                        default:
                            // Ignore unknown operators
                            break;
                    }
                }
                return currentResult;
            } catch (e) {
                console.error("Calculation error:", e);
                return 0;
            }
        }

        function calculate(trigger) {
            const input = document.getElementById('calc-input').value;
            const resJpyDisplay = document.getElementById('calc-result-jpy');
            const resHkdDisplay = document.getElementById('calc-result-hkd');
            
            if(!input) {
                resJpyDisplay.innerText = "0";
                resHkdDisplay.innerText = "0.0";
                return;
            }

            if (trigger === '=') {
                const jpy = performSafeCalculation(input);
                const hkd = (jpy * currentRate).toFixed(1);
                
                resJpyDisplay.innerText = jpy.toLocaleString('en-US', { maximumFractionDigits: 0 });
                resHkdDisplay.innerText = hkd;
                document.getElementById('calc-input').value = jpy.toString(); // Replace expression with result
            } else {
                // Live calculation preview
                const jpy = performSafeCalculation(input);
                const hkd = (jpy * currentRate).toFixed(1);

                resJpyDisplay.innerText = jpy.toLocaleString('en-US', { maximumFractionDigits: 0 });
                resHkdDisplay.innerText = hkd;
            }
        }

        // --- WALLET / EXPENSES LOGIC ---
        let tempPhotoData = null;

        function handlePhotoSelect(input) {
            const file = input.files[0];
            const previewText = document.getElementById('photo-preview-text');
            if (file) {
                previewText.innerText = "讀取中...";
                previewText.classList.remove('text-green-600');

                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = new Image();
                    img.onload = function() {
                        // Compress Image using Canvas
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        const MAX_WIDTH = 300; // Resize to thumbnail
                        
                        let width = img.width;
                        let height = img.height;
                        if (width > MAX_WIDTH) {
                            height *= MAX_WIDTH / width;
                            width = MAX_WIDTH;
                        }
                        
                        canvas.width = width;
                        canvas.height = height;
                        
                        ctx.drawImage(img, 0, 0, width, height);
                        // Convert to Base64, JPEG format, quality 70%
                        tempPhotoData = canvas.toDataURL('image/jpeg', 0.7); 
                        
                        previewText.innerText = "照片已準備";
                        previewText.classList.add('text-green-600');
                    }
                    img.src = e.target.result;
                }
                reader.readAsDataURL(file);
            }
        }

        function addExpense() {
            const item = document.getElementById('expense-item').value.trim();
            const amount = parseFloat(document.getElementById('expense-amount').value);
            
            // Custom modal replacement for alert
            if (!item || isNaN(amount) || amount <= 0) {
                alert('請輸入有效的「品項」與「金額」。');
                return;
            }

            expenses.unshift({
                id: Date.now(),
                item: item,
                amount: amount,
                date: new Date().toLocaleDateString('zh-TW', { month: '2-digit', day: '2-digit' }),
                photo: tempPhotoData
            });

            setLocalItem('tokyo_expenses', expenses);
            
            // Reset form
            document.getElementById('expense-item').value = "";
            document.getElementById('expense-amount').value = "";
            document.getElementById('expense-photo').value = ""; // Clear file input
            document.getElementById('photo-preview-text').innerText = "未選擇";
            document.getElementById('photo-preview-text').classList.remove('text-green-600');
            tempPhotoData = null;

            renderExpenses();
        }

        function deleteExpense(id) {
            if(confirm('確定刪除此紀錄？')) {
                expenses = expenses.filter(e => e.id !== id);
                setLocalItem('tokyo_expenses', expenses);
                renderExpenses();
            }
        }

        function renderExpenses() {
            const list = document.getElementById('expense-list');
            const totalEl = document.getElementById('total-expense');
            if (!list || !totalEl) return;
            
            let html = '';
            let total = 0;

            expenses.forEach(ex => {
                total += ex.amount;
                const hkd = (ex.amount * currentRate).toFixed(1);
                
                html += `
                <div class="bg-white p-3 rounded-lg shadow-sm flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        ${ex.photo ? `<img src="${ex.photo}" class="w-12 h-12 rounded object-cover border border-gray-100 cursor-pointer" onclick="showImage('${ex.photo}', event)">` : '<div class="w-12 h-12 bg-gray-100 rounded flex items-center justify-center text-gray-300"><i class="fas fa-shopping-bag"></i></div>'}
                        <div>
                            <p class="font-bold text-muji-text">${ex.item}</p>
                            <p class="text-xs text-gray-400">${ex.date}</p>
                        </div>
                    </div>
                    <div class="text-right">
                        <p class="font-bold text-muji-text">¥${ex.amount.toLocaleString()}</p>
                        <p class="text-xs text-muji-sub">≈ HK$${hkd}</p>
                        <button onclick="deleteExpense(${ex.id})" class="text-xs text-red-400 mt-1 hover:text-red-600">刪除</button>
                    </div>
                </div>`;
            });

            list.innerHTML = html;
            totalEl.innerText = total.toLocaleString();
        }

        function showImage(src, event) {
            // Prevent event bubbling to modal click handler
            if (event) event.stopPropagation();
            
            const modal = document.getElementById('image-modal');
            document.getElementById('modal-img').src = src;
            modal.classList.add('active');
        }

        // --- LISTS LOGIC ---
        function renderTodos() {
            const container = document.getElementById('checklist-container');
            if (!container) return;
            let html = '';
            
            // Sort to show incomplete items first
            const sortedTodos = [...todos].sort((a, b) => (a.done === b.done) ? 0 : a.done ? 1 : -1);

            sortedTodos.forEach((todo, index) => {
                // Find original index to update the 'todos' array correctly
                const originalIndex = todos.findIndex(t => t.text === todo.text && t.done === todo.done);

                html += `
                <label class="flex items-center gap-3 p-2 bg-gray-50 rounded hover:bg-gray-100 transition cursor-pointer">
                    <input type="checkbox" ${todo.done ? 'checked' : ''} onchange="toggleTodo(${originalIndex})" class="w-5 h-5 text-muji-accent rounded focus:ring-muji-accent">
                    <span class="${todo.done ? 'line-through text-gray-400' : 'text-gray-700'} flex-1">${todo.text}</span>
                    <button onclick="deleteTodo(${originalIndex}, event)" class="text-gray-300 hover:text-red-400 p-1"><i class="fas fa-times text-sm"></i></button>
                </label>`;
            });
            container.innerHTML = html;
        }

        function addTodo() {
            const input = document.getElementById('new-todo');
            const text = input.value.trim();
            if(text) {
                todos.push({ text: text, done: false });
                setLocalItem('tokyo_todos', todos);
                input.value = '';
                renderTodos();
            }
        }

        function toggleTodo(index) {
            // Index is the original index in the 'todos' array
            if (todos[index]) {
                todos[index].done = !todos[index].done;
                setLocalItem('tokyo_todos', todos);
                renderTodos();
            }
        }

        function deleteTodo(index, event) {
            // Prevent the label's click event (which toggles the checkbox) from firing
            if (event) event.stopPropagation(); 
            
            if (todos[index]) {
                todos.splice(index, 1);
                setLocalItem('tokyo_todos', todos);
                renderTodos();
            }
        }

        function updateMemoLinks(text) {
            const container = document.getElementById('memo-links');
            // Regex to find URLs
            const urlRegex = /(https?:\/\/[^\s]+)/g;
            const matches = text.match(urlRegex);
            
            if(container) {
                 if(matches && matches.length > 0) {
                    // Use a Set to ensure unique links
                    const uniqueMatches = [...new Set(matches)]; 
                    
                    container.innerHTML = uniqueMatches.map(url => {
                        let displayUrl = url.length > 30 ? url.substring(0, 27) + '...' : url;
                        return `
                        <a href="${url}" target="_blank" class="text-xs bg-blue-50 text-blue-600 px-3 py-2 rounded-full truncate max-w-[50%] inline-block border border-blue-100 font-medium hover:bg-blue-100 transition">
                            <i class="fas fa-link mr-1"></i> ${displayUrl}
                        </a>`;
                    }).join('');
                } else {
                    container.innerHTML = '';
                }
            }
           
        }

    </script>
</body>
</html>
