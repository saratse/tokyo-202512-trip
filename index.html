<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>2025 命運之星東京之旅</title>
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Noto+Serif+TC:wght@400;700&display=swap" rel="stylesheet">
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            /* Suikoden Palette */
            --bg-dark: #0f172a; /* Deep Night Blue */
            --primary: #1e3a8a; /* Standard Blue */
            --accent: #d4af37; /* Gold/Bronze */
            --accent-light: #fcd34d;
            --paper: #f5f5dc; /* Parchment */
            --paper-dark: #e8e6cd;
            --text-main: #2c2c2c;
            --text-light: #f0f0f0;
            --danger: #991b1b;
            --success: #166534;
            --card-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5), 0 2px 4px -1px rgba(0, 0, 0, 0.3);
        }

        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: 'Noto Serif TC', serif;
            background-color: var(--bg-dark);
            background-image: radial-gradient(circle at 50% 50%, #1e293b 0%, #0f172a 100%);
            color: var(--text-main);
            min-height: 100vh;
            padding-bottom: 90px; /* Space for navbar */
        }

        /* Utility */
        .hidden { display: none !important; }
        .text-gold { color: var(--accent); }
        .cinzel { font-family: 'Cinzel', serif; }
        
        /* Header */
        header {
            background: linear-gradient(180deg, rgba(15, 23, 42, 0.95) 0%, rgba(30, 58, 138, 0.8) 100%);
            color: var(--accent);
            padding: 15px;
            text-align: center;
            border-bottom: 2px solid var(--accent);
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(5px);
        }
        header h1 { margin: 0; font-size: 1.4rem; letter-spacing: 1px; text-shadow: 2px 2px 4px black; }

        /* Container */
        .container {
            padding: 15px;
            max-width: 600px;
            margin: 0 auto;
        }

        /* Cards (RPG Style) */
        .rpg-card {
            background: var(--paper);
            border: 2px solid #8b7355;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            position: relative;
            box-shadow: var(--card-shadow);
        }
        
        /* Ornamental Corners for Cards */
        .rpg-card::before, .rpg-card::after {
            content: '';
            position: absolute;
            width: 10px;
            height: 10px;
            border: 2px solid var(--accent);
            transition: all 0.3s ease;
        }
        .rpg-card::before { top: 4px; left: 4px; border-right: none; border-bottom: none; }
        .rpg-card::after { bottom: 4px; right: 4px; border-left: none; border-top: none; }

        .card-title {
            font-family: 'Cinzel', serif;
            font-weight: 700;
            color: #4a3b2a;
            border-bottom: 1px solid #8b7355;
            padding-bottom: 5px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Info Rows */
        .info-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 0.95rem;
        }
        .label { font-weight: bold; color: #666; }
        .value { text-align: right; font-weight: 600; color: #222; }

        /* Buttons */
        .btn {
            background: linear-gradient(180deg, #3b82f6 0%, #1d4ed8 100%);
            border: 1px solid #93c5fd;
            color: white;
            padding: 8px 16px;
            border-radius: 4px;
            font-family: 'Noto Serif TC', serif;
            font-weight: bold;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
            font-size: 0.9rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            text-align: center;
        }
        .btn:active { transform: translateY(1px); box-shadow: none; }
        .btn-sm { padding: 4px 10px; font-size: 0.8rem; }
        .btn-gold {
            background: linear-gradient(180deg, #fcd34d 0%, #d97706 100%);
            border: 1px solid #fde68a;
            color: #451a03;
        }
        .btn-map { background: linear-gradient(180deg, #22c55e 0%, #15803d 100%); border-color: #86efac; }
        .btn-food { background: linear-gradient(180deg, #f97316 0%, #c2410c 100%); border-color: #fdba74; }
        .btn-danger { background: linear-gradient(180deg, #ef4444 0%, #b91c1c 100%); border-color: #fca5a5; }

        /* Navigation Bottom Bar */
        .nav-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: linear-gradient(0deg, #0f172a 0%, #1e293b 100%);
            display: flex;
            justify-content: space-around;
            padding: 10px 0;
            border-top: 2px solid var(--accent);
            box-shadow: 0 -4px 10px rgba(0,0,0,0.5);
            z-index: 1000;
        }

        .nav-item {
            color: #64748b;
            text-align: center;
            font-size: 0.75rem;
            background: none;
            border: none;
            cursor: pointer;
            flex: 1;
            transition: color 0.3s;
        }
        .nav-item i {
            display: block;
            font-size: 1.2rem;
            margin-bottom: 4px;
        }
        .nav-item.active {
            color: var(--accent);
            text-shadow: 0 0 5px rgba(212, 175, 55, 0.5);
        }
        .nav-item.active i { transform: scale(1.1); transition: transform 0.2s; }

        /* Timeline (Itinerary) */
        .timeline {
            position: relative;
            padding-left: 20px;
            border-left: 3px solid var(--accent);
            margin-left: 10px;
        }
        .timeline-item {
            margin-bottom: 25px;
            position: relative;
        }
        .timeline-dot {
            position: absolute;
            left: -33px; /* Adjusted for larger size to keep centered */
            top: 0;
            width: 26px; /* Larger Width */
            height: 26px; /* Larger Height */
            background: var(--accent);
            border-radius: 50%;
            border: 2px solid #fff;
            box-shadow: 0 0 5px var(--accent);
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 14px; /* Larger Icon Font Size */
            color: #451a03;
        }
        .timeline-time {
            font-family: 'Cinzel', serif;
            font-weight: bold;
            color: var(--accent-light);
            font-size: 1.1rem;
            margin-bottom: 4px;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
        }
        .timeline-content {
            background: rgba(255, 255, 255, 0.7);
            border-radius: 6px;
            padding: 10px;
            border: 1px solid #d1d5db;
        }
        .timeline-actions {
            margin-top: 8px;
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        .timeline-img-preview {
            margin-top: 10px;
            width: 100%;
            height: 120px;
            object-fit: cover;
            border-radius: 4px;
            border: 1px solid #ccc;
            cursor: pointer;
        }

        /* Memo Sticky Notes */
        .memo-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
        }
        .memo-card {
            background: #fffef0;
            border: 1px solid #d4af37;
            padding: 15px;
            border-radius: 2px;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.2);
            position: relative;
            transition: transform 0.2s;
        }
        .memo-card::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0;
            height: 20px;
            background: rgba(212, 175, 55, 0.2);
            border-bottom: 1px solid rgba(212, 175, 55, 0.3);
        }
        .memo-text {
            margin-top: 15px;
            white-space: pre-wrap;
            font-size: 1rem;
            line-height: 1.5;
            word-break: break-all;
        }
        .memo-img {
            width: 100%;
            margin-top: 10px;
            border-radius: 4px;
            border: 1px solid #ccc;
            cursor: pointer;
        }
        .memo-actions {
            margin-top: 10px;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        /* Spotlight (Lightbox) */
        .lightbox {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 3000;
            cursor: zoom-out;
            padding: 20px;
        }
        .lightbox img {
            max-width: 95%;
            max-height: 95%;
            object-fit: contain;
            border: 2px solid var(--accent);
        }
        
        /* Text Spotlight Specifics */
        .spotlight-card {
            background: var(--paper);
            border: 4px solid var(--accent);
            border-radius: 8px;
            padding: 30px;
            max-width: 100%;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            text-align: center;
            box-shadow: 0 0 50px rgba(212, 175, 55, 0.4);
            cursor: default;
        }
        .spotlight-text {
            font-size: 1.8rem;
            font-weight: bold;
            color: #000;
            line-height: 1.4;
            white-space: pre-wrap;
            word-break: break-all;
            margin-bottom: 20px;
        }
        .spotlight-img {
            max-width: 100%;
            max-height: 50vh;
            border: 2px solid #8b7355;
            margin-top: 10px;
            cursor: zoom-in; /* Indicate visual interaction */
        }

        /* Checklist */
        .checklist-item {
            display: flex;
            align-items: center;
            padding: 10px;
            border-bottom: 1px dashed #ccc;
            cursor: pointer;
        }
        .checklist-item:last-child { border-bottom: none; }
        .checklist-item input[type="checkbox"] {
            margin-right: 12px;
            transform: scale(1.3);
            accent-color: var(--primary);
        }
        .checklist-item.checked span {
            text-decoration: line-through;
            color: #999;
        }

        /* Inputs */
        input[type="text"], textarea, select {
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid #8b7355;
            background: #fffef0;
            border-radius: 4px;
            font-family: 'Noto Serif TC', serif;
        }
        
        /* Modal */
        .modal {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }
        .modal-content {
            background: var(--paper);
            padding: 20px;
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
            border: 2px solid var(--accent);
            max-height: 95vh;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        /* Weather Widget */
        .weather-widget {
            background: linear-gradient(135deg, #60a5fa 0%, #2563eb 100%);
            color: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.2);
        }
        .weather-day-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255,255,255,0.3);
        }
        .weather-day-row:last-child { border-bottom: none; }
        .temp-high { color: #fee2e2; font-weight: bold; }
        .temp-low { color: #e0f2fe; opacity: 0.9; }

        /* Floating Add Button */
        .fab {
            position: fixed;
            bottom: 100px;
            right: 20px;
            width: 56px;
            height: 56px;
            background: var(--accent);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
            color: #451a03;
            font-size: 24px;
            border: 2px solid #fff;
            cursor: pointer;
            z-index: 900;
            transition: transform 0.2s;
        }
        .fab:active { transform: scale(0.95); }
        
        /* Date Tabs */
        .date-tabs {
            display: flex;
            overflow-x: auto;
            gap: 10px;
            padding-bottom: 10px;
            margin-bottom: 15px;
        }
        .date-tab {
            background: rgba(255,255,255,0.2);
            color: #ddd;
            padding: 6px 12px;
            border-radius: 15px;
            white-space: nowrap;
            font-size: 0.9rem;
            border: 1px solid transparent;
        }
        .date-tab.active {
            background: var(--accent);
            color: #2c2c2c;
            border-color: #fff;
            font-weight: bold;
        }

        /* Upload Button Style */
        .upload-area {
            border: 2px dashed #8b7355;
            background: rgba(255,255,255,0.4);
            padding: 15px;
            text-align: center;
            border-radius: 6px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: background 0.2s;
        }
        .upload-area:hover, .upload-area.highlight {
            background: rgba(255,255,255,0.7);
            border-color: var(--primary);
        }
        .upload-area p { margin: 5px 0 0 0; font-size: 0.85rem; color: #666; }

        /* Input Group with Copy Button (New) */
        .input-group {
            display: flex;
            gap: 5px;
            margin-bottom: 12px;
            align-items: flex-end;
        }
        .input-wrapper {
            flex: 1;
        }
        .input-wrapper label {
            display: block;
            font-size: 0.8rem;
            color: #666;
            margin-bottom: 2px;
            font-weight: bold;
        }
        .input-group input {
            margin-bottom: 0;
            width: 100%;
        }
        .btn-copy {
            background: linear-gradient(180deg, #475569 0%, #334155 100%);
            border: 1px solid #64748b;
            color: #fff;
            width: 44px;
            height: 43px; /* Match input height approx */
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .btn-copy:active { transform: translateY(1px); box-shadow: none; }
    </style>
</head>
<body>

    <header>
        <h1 class="cinzel"><i class="fa-solid fa-dragon"></i> 東京快閃 2025</h1>
        <div style="font-size: 0.8rem; color: #aaa;">12/10 - 12/14 命運之旅</div>
    </header>

    <div class="container">
        
        <!-- SECTION: FLIGHT & HOTEL -->
        <section id="sec-booking">
            
            <!-- Flights -->
            <div class="rpg-card">
                <div class="card-title"><i class="fa-solid fa-plane-departure"></i> 航班資訊</div>
                <div style="background: rgba(0,0,0,0.05); padding: 10px; border-radius: 4px; margin-bottom: 10px;">
                    <div class="info-row"><span class="label">去程 (HK Express)</span></div>
                    <div class="info-row"><span class="value">UO624</span> <span class="value">12/10 23:55 HND T3</span></div>
                    <div style="font-size: 0.8rem; color: #666; text-align: right;">抵達: 12/11 04:45</div>
                </div>
                <div style="background: rgba(0,0,0,0.05); padding: 10px; border-radius: 4px;">
                    <div class="info-row"><span class="label">回程 (HK Express)</span></div>
                    <div class="info-row"><span class="value">UO629</span> <span class="value">12/14 01:55 HND T3</span></div>
                    <div style="font-size: 0.8rem; color: #666; text-align: right;">抵達: 12/14 06:15 HKG</div>
                </div>
            </div>

            <!-- Accommodation -->
            <div class="rpg-card">
                <div class="card-title"><i class="fa-solid fa-bed"></i> 住宿據點</div>
                <h3 style="margin: 5px 0; color: #1e3a8a;">Dormy Inn Ikebukuro</h3>
                <p style="font-size: 0.9rem; margin: 5px 0;">天然温泉 豊穣の湯 ドーミーイン池袋</p>
                <div class="info-row" style="margin-top: 10px;">
                    <span class="label">地址</span>
                    <span class="value" style="font-size: 0.8rem; max-width: 70%;">東京都豊島区東池袋3-11-11</span>
                </div>
                <div class="info-row">
                    <span class="label">電話</span>
                    <span class="value">+81-3-5956-548</span>
                </div>
                <div class="info-row">
                    <span class="label">Agoda 訂單</span>
                    <span class="value text-gold" style="font-weight:bold;">請參閱電郵</span>
                </div>
                <div class="info-row">
                    <span class="label">入住/退房</span>
                    <span class="value">12/11 In - 12/13 Out</span>
                </div>
                <div style="margin-top: 10px; text-align: right;">
                    <a href="https://www.google.com/maps/search/?api=1&query=Dormy+Inn+Ikebukuro" target="_blank" class="btn btn-map btn-sm"><i class="fa-solid fa-map-location-dot"></i> 導航</a>
                </div>
            </div>

            <!-- Personal Info (Moved to Bottom) -->
            <div class="rpg-card">
                <div class="card-title"><i class="fa-solid fa-address-card"></i> 個人資訊 (僅存本機)</div>
                <div id="personalInfoContainer">
                    <!-- JS Generated Inputs -->
                </div>
                <div style="text-align:right; font-size:0.75rem; color:#888; margin-top:5px;">
                    * 點擊右側按鈕即可複製
                </div>
            </div>
        </section>

        <!-- SECTION: ITINERARY -->
        <section id="sec-itinerary" class="hidden">
            <div class="date-tabs" id="dayTabs">
                <!-- JS Generated -->
            </div>

            <div id="itineraryContent">
                <!-- JS Generated Timeline -->
            </div>
            
            <div style="height: 60px;"></div> <!-- Spacer -->
        </section>

        <!-- SECTION: CHECKLIST & MEMO -->
        <section id="sec-memo" class="hidden">
            <!-- Checklist -->
            <div class="rpg-card">
                <div class="card-title"><i class="fa-solid fa-clipboard-check"></i> 行前準備</div>
                <div id="checklistContainer">
                    <!-- JS Generated -->
                </div>
                <div style="margin-top: 10px; display: flex; gap: 5px;">
                    <input type="text" id="newCheckItem" placeholder="新增清單項目..." style="margin-bottom: 0;">
                    <button class="btn btn-gold" onclick="addCheckItem()">+</button>
                </div>
            </div>

            <!-- Memo Cards -->
            <div style="margin-top: 20px;">
                <div class="card-title" style="color:white; border-bottom-color: var(--accent);"><i class="fa-solid fa-note-sticky"></i> 旅人筆記 & 便條</div>
                <p style="color:#aaa; font-size:0.8rem; margin-top:-5px;">點擊「放大」進入聚光燈模式，方便出示給店員</p>
                <div id="memoContainer" class="memo-grid">
                    <!-- JS Generated Memo Cards -->
                </div>
            </div>
        </section>

        <!-- SECTION: INFO -->
        <section id="sec-info" class="hidden">
            <div class="rpg-card">
                <div class="card-title"><i class="fa-solid fa-cloud-sun-rain"></i> 天氣預報 (東京)</div>
                <div id="weatherDisplay" class="weather-widget">
                    <i class="fa-solid fa-spinner fa-spin"></i> 讀取氣象廳資料中...
                </div>
                <div style="text-align: center;">
                    <a href="https://www.jma.go.jp/bosai/forecast/#area_type=offices&area_code=130000" target="_blank" class="btn btn-sm" style="background: #222;">前往日本氣象廳</a>
                </div>
            </div>

            <div class="rpg-card">
                <div class="card-title"><i class="fa-solid fa-kit-medical"></i> 緊急聯絡</div>
                <div class="info-row">
                    <span class="label">警察 (Police)</span>
                    <a href="tel:110" class="btn btn-danger btn-sm">110</a>
                </div>
                <div class="info-row">
                    <span class="label">救護/火警</span>
                    <a href="tel:119" class="btn btn-danger btn-sm">119</a>
                </div>
                <div class="info-row">
                    <span class="label">外交部急難救助</span>
                    <a href="tel:+81-3-3280-7811" class="btn btn-sm">辦事處電話</a>
                </div>
                <hr style="border-color: #8b7355; opacity: 0.3;">
                <!-- Removed 7-Eleven text -->
            </div>
        </section>

    </div>

    <!-- Floating Action Button (Only on Itinerary or Memo) -->
    <div id="fabAdd" class="fab hidden" onclick="handleFabClick()">
        <i class="fa-solid fa-plus"></i>
    </div>

    <!-- Edit Itinerary Modal -->
    <div id="editModal" class="modal hidden">
        <div class="modal-content">
            <h3 class="cinzel" style="margin-top: 0; margin-bottom: 15px; border-bottom: 2px solid var(--accent); padding-bottom: 10px;">
                <i class="fa-solid fa-pen-nib"></i> 編輯行程
            </h3>
            <input type="hidden" id="editId">
            
            <label style="font-weight:bold; color:#666; margin-bottom:5px;">時間 (24小時制)</label>
            <input type="text" id="editTime" placeholder="例如 1430 或 14:30" inputmode="numeric" onblur="formatTimeInput(this)">
            
            <label style="font-weight:bold; color:#666; margin-bottom:5px;">活動標題</label>
            <input type="text" id="editTitle" placeholder="例：吃拉麵">
            
            <label style="font-weight:bold; color:#666; margin-bottom:5px;">地點/備註 (可輸入長文)</label>
            <textarea id="editDesc" rows="8" placeholder="輸入地點、地址、預約編號或其他細節..."></textarea>
            
            <label style="font-weight:bold; color:#666; margin-bottom:5px;">圖片 (QR Code / 地圖)</label>
            <div class="upload-area" onclick="document.getElementById('editImageInput').click()" id="uploadDropZone">
                <i class="fa-solid fa-image" style="font-size: 24px; color: var(--primary);"></i>
                <p>點擊上傳 或 <strong>直接貼上(Paste)</strong> 圖片</p>
                <input type="file" id="editImageInput" accept="image/*" onchange="handleImageUpload(this, 'itinerary')" style="display: none;">
            </div>
            <div id="editImagePreviewContainer" style="margin-bottom:15px; display:none; text-align:center;">
                <img id="editImagePreview" src="" style="max-height:150px; border:2px solid var(--accent); border-radius:4px; box-shadow:0 2px 5px rgba(0,0,0,0.2);">
                <div style="margin-top:5px;">
                    <button type="button" class="btn btn-danger btn-sm" onclick="clearEditImage('itinerary')"><i class="fa-solid fa-trash"></i> 刪除圖片</button>
                </div>
            </div>
            
            <label style="font-weight:bold; color:#666; margin-bottom:5px;">類型</label>
            <select id="editType">
                <option value="activity">一般活動</option>
                <option value="food">用餐 (顯示食記鈕)</option>
                <option value="shopping">購物</option>
                <option value="transport">交通</option>
            </select>
            
            <label style="font-weight:bold; color:#666; margin-bottom:5px;">外部連結</label>
            <input type="text" id="editLink" placeholder="Google Maps 或 食記網址">
            
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="btn btn-danger" style="flex: 1;" onclick="closeModal('editModal')">取消</button>
                <button class="btn btn-gold" style="flex: 1;" onclick="saveItineraryItem()"><i class="fa-solid fa-floppy-disk"></i> 儲存</button>
            </div>
            <button id="btnDeleteItinerary" class="btn btn-danger" style="width: 100%; margin-top: 15px; opacity:0.7;" onclick="deleteItem()"><i class="fa-solid fa-trash-can"></i> 刪除此項目</button>
        </div>
    </div>

    <!-- Add/Edit Memo Modal -->
    <div id="memoModal" class="modal hidden">
        <div class="modal-content">
            <h3 class="cinzel" style="margin-top: 0; margin-bottom: 15px; border-bottom: 2px solid var(--accent); padding-bottom: 10px;">
                <i class="fa-solid fa-note-sticky"></i> 編輯便條
            </h3>
            <input type="hidden" id="memoId">
            
            <label style="font-weight:bold; color:#666; margin-bottom:5px;">內容 (例如: 取票代號)</label>
            <textarea id="memoText" rows="5" placeholder="輸入文字內容..."></textarea>
            
            <label style="font-weight:bold; color:#666; margin-bottom:5px;">圖片 (條碼 / 截圖)</label>
            <div class="upload-area" onclick="document.getElementById('memoImageInput').click()" id="memoDropZone">
                <i class="fa-solid fa-camera" style="font-size: 24px; color: var(--primary);"></i>
                <p>點擊上傳 或 <strong>貼上圖片</strong></p>
                <input type="file" id="memoImageInput" accept="image/*" onchange="handleImageUpload(this, 'memo')" style="display: none;">
            </div>
            <div id="memoImagePreviewContainer" style="margin-bottom:15px; display:none; text-align:center;">
                <img id="memoImagePreview" src="" style="max-height:150px; border:2px solid var(--accent); border-radius:4px;">
                <div style="margin-top:5px;">
                    <button type="button" class="btn btn-danger btn-sm" onclick="clearEditImage('memo')">刪除圖片</button>
                </div>
            </div>

            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="btn btn-danger" style="flex: 1;" onclick="closeModal('memoModal')">取消</button>
                <button class="btn btn-gold" style="flex: 1;" onclick="saveMemo()"><i class="fa-solid fa-check"></i> 儲存</button>
            </div>
        </div>
    </div>

    <!-- Lightbox (For plain images) -->
    <div id="lightbox" class="lightbox hidden" onclick="closeLightbox()">
        <img id="lightboxImg" src="">
    </div>

    <!-- Spotlight (For Text + Image) -->
    <div id="memoSpotlight" class="lightbox hidden" onclick="closeMemoSpotlight()">
        <div class="spotlight-card" onclick="event.stopPropagation()">
            <div id="memoSpotlightText" class="spotlight-text"></div>
            <img id="memoSpotlightImg" class="spotlight-img hidden">
            <div style="margin-top:30px;">
                <button class="btn btn-danger" onclick="closeMemoSpotlight()">關閉</button>
            </div>
        </div>
    </div>

    <!-- Navigation -->
    <nav class="nav-bar">
        <button class="nav-item active" onclick="switchTab('sec-booking', this)">
            <i class="fa-solid fa-ticket"></i> 預訂
        </button>
        <button class="nav-item" onclick="switchTab('sec-itinerary', this)">
            <i class="fa-solid fa-scroll"></i> 行程
        </button>
        <button class="nav-item" onclick="switchTab('sec-memo', this)">
            <i class="fa-solid fa-list-check"></i> 清單
        </button>
        <button class="nav-item" onclick="switchTab('sec-info', this)">
            <i class="fa-solid fa-circle-info"></i> 資訊
        </button>
    </nav>

    <script>
        // --- DATA INITIALIZATION ---
        const DATA_VERSION = 6.3; // Version Bump for Memo Performance Fix
        
        const DEFAULT_DATA = {
            version: DATA_VERSION,
            personalInfo: {
                nameCh: '',
                nameEn: '',
                passport: '',
                dob: '',
                email: '',
                passportExpiry: '' // Added field
            },
            itinerary: [
                // D1
                { id: 1, day: 'D1', date: '12/11', time: '04:45', title: '抵達羽田 T3', desc: '入境清關(預計05:30完成) → 領 SIM 卡(JAL ABC) → Refresh Room 梳洗 → 寄行李', type: 'transport', link: 'https://tokyo-haneda.com/zh-CHT/service/facilities/shower_room.html' },
                { id: 2, day: 'D1', date: '12/11', time: '08:30', title: '利木津巴士 → 池袋', desc: '巴士站 2 號乘車處。\n前往 Dormy Inn 寄放行李 (10:00 抵達)', type: 'transport', link: '' },
                { id: 3, day: 'D1', date: '12/11', time: '10:30', title: '東京車站購物', desc: '1. 皇居長夾\n2. BUTTER 甜點\n3. 7-11 領票 (代碼: 2269602155961)', type: 'shopping', link: 'https://www.google.com/maps/search/?api=1&query=Tokyo+Station' },
                { id: 4, day: 'D1', date: '12/11', time: '12:30', title: '午餐', desc: '東京車站周邊快速解決', type: 'food', link: 'https://tabelog.com/tw/tokyo/A1302/A130201/13035932/' },
                { id: 5, day: 'D1', date: '12/11', time: '14:30', title: 'Chiikawa Park 購物', desc: 'Sunshine City Annex 1F。\n無需門票，專注 1F 商店。', type: 'shopping', link: 'https://www.google.com/maps/search/?api=1&query=Sunshine+City+Tokyo' },
                { id: 6, day: 'D1', date: '12/11', time: '16:00', title: 'Check-in 休息', desc: 'Dormy Inn 辦理入住，稍作休息。', type: 'activity', link: '' },
                { id: 7, day: 'D1', date: '12/11', time: '17:00', title: 'Gallery AaMo 展覽 (一刷)', desc: '東京巨蛋城。錯開人潮，傍晚參觀。', type: 'activity', link: 'https://www.google.com/maps/search/?api=1&query=Gallery+AaMo+Tokyo+Dome+City' },
                { id: 8, day: 'D1', date: '12/11', time: '20:30', title: '晚餐 & 溫泉', desc: '池袋周邊覓食，回飯店享受天然温泉「豊穣の湯」。', type: 'food', link: '' },
                // D2
                { id: 21, day: 'D2', date: '12/12', time: '09:00', title: '飯店早餐', desc: '悠閒享用 Dormy Inn 早餐', type: 'food', link: '' },
                { id: 22, day: 'D2', date: '12/12', time: '10:00', title: 'Gallery AaMo 展覽 (二刷)', desc: '上午時段，預計 2 小時。', type: 'activity', link: 'https://www.google.com/maps/search/?api=1&query=Gallery+AaMo+Tokyo+Dome+City' },
                { id: 23, day: 'D2', date: '12/12', time: '12:00', title: '午餐 & 移動', desc: '東京巨蛋周邊 → 新宿/代代木', type: 'food', link: '' },
                { id: 24, day: 'D2', date: '12/12', time: '13:30', title: '新宿賞楓 & 購物', desc: '1. 新宿御苑 (紅葉/銀杏)\n2. Workman Plus (池袋太陽城店)', type: 'shopping', link: 'https://www.google.com/maps/search/?api=1&query=Shinjuku+Gyoen' },
                { id: 25, day: 'D2', date: '12/12', time: '20:00', title: '溫泉休息', desc: '回到溫暖的據點', type: 'activity', link: '' },
                // D3
                { id: 31, day: 'D3', date: '12/13', time: '11:00', title: '退房 & 寄行李', desc: '11:00 準時退房，行李寄放櫃台。', type: 'activity', link: '' },
                { id: 32, day: 'D3', date: '12/13', time: '11:30', title: '明治神宮參拜', desc: '參拜後於原宿區域午餐。', type: 'activity', link: 'https://www.google.com/maps/search/?api=1&query=Meiji+Jingu' },
                { id: 33, day: 'D3', date: '12/13', time: '13:00', title: '池袋最終採購', desc: 'P\'PARCO, Bic Camera。\n彈性：ISEKI 池袋店 (東池袋1-15-1 B1F)', type: 'shopping', link: 'https://www.google.com/maps/search/?api=1&query=Ikebukuro+Station' },
                { id: 34, day: 'D3', date: '12/13', time: '18:45', title: '出發去機場', desc: '回飯店拿行李，務必 19:00 出發前往 HND。', type: 'transport', link: '' },
                // D4
                { id: 41, day: 'D4', date: '12/14', time: '01:55', title: '飛機起飛', desc: 'UO629 回香港 (06:15 抵達)', type: 'transport', link: '' }
            ],
            checklist: [
                { text: '護照 & 日本入境 QR Code (VJW)', checked: false },
                { text: 'SIM 卡取件單 / 漫遊開通', checked: false },
                { text: 'Agoda 訂房憑證', checked: false },
                { text: '7-11 取票代碼 (2269602155961)', checked: false },
                { text: '行動電源 & 充電線', checked: false },
                { text: '日幣現金', checked: false },
                { text: '牙刷/個人藥品', checked: false }
            ],
            memos: [
                { id: 101, text: "7-11 發券番號: 2269602155961", image: null },
                { id: 102, text: "ISEKI 地址: 東池袋1-15-1 真下ビル B1F", image: null }
            ]
        };

        // --- STATE & STORAGE ---
        let appData = null;
        try {
            const stored = JSON.parse(localStorage.getItem('tokyoTrip2025'));
            if (!stored || !stored.version || stored.version < DATA_VERSION) {
                appData = JSON.parse(JSON.stringify(DEFAULT_DATA));
                if(stored) {
                    // Preserve existing data during migration
                    if(stored.personalInfo) appData.personalInfo = stored.personalInfo;
                    if(stored.checklist) {
                        appData.checklist = DEFAULT_DATA.checklist.map(newItem => {
                            const oldItem = stored.checklist.find(o => o.text === newItem.text);
                            return oldItem ? { ...newItem, checked: oldItem.checked } : newItem;
                        });
                    }
                    if(stored.memos) appData.memos = stored.memos;
                    else if(stored.memo && typeof stored.memo === 'string') {
                        appData.memos.push({ id: Date.now(), text: stored.memo, image: null });
                    }
                    // Keep edited itinerary if user wants, but here we reset itinerary for structure updates usually. 
                    // To be safe for personal info updates, we keep user's edited itinerary if possible, 
                    // but since V5->V6 is mainly adding personalInfo, let's keep itinerary if structure matches.
                    if(stored.itinerary && stored.version >= 5.0) appData.itinerary = stored.itinerary;
                }
                console.log("Data migration: Updated to version " + DATA_VERSION);
            } else {
                appData = stored;
            }
        } catch(e) {
            appData = DEFAULT_DATA;
        }

        let currentDayTab = 'D1';
        // --- PERSONAL INFO LOGIC (New) ---
        const INFO_FIELDS = [
            { key: 'nameCh', label: '中文姓名' },
            { key: 'nameEn', label: '英文姓名 (Last, First)' },
            { key: 'passport', label: '護照號碼' },
            { key: 'dob', label: '出生日期 (YYYY/MM/DD)' },
            { key: 'email', label: 'Email' },
            { key: 'passportExpiry', label: '護照有效日期 (YYYY/MM/DD)' } // Changed from phone
        ];

        function renderPersonalInfo() {
            const container = document.getElementById('personalInfoContainer');
            if(!container) return;
            container.innerHTML = '';

            INFO_FIELDS.forEach(field => {
                const val = appData.personalInfo[field.key] || '';
                
                const div = document.createElement('div');
                div.className = 'input-group';
                div.innerHTML = `
                    <div class="input-wrapper">
                        <label>${field.label}</label>
                        <input type="text" id="pi-${field.key}" value="${val}" oninput="updatePersonalInfo('${field.key}', this.value)">
                    </div>
                    <button class="btn-copy" onclick="copyText('pi-${field.key}')">
                        <i class="fa-regular fa-copy"></i>
                    </button>
                `;
                container.appendChild(div);
            });
        }

        function updatePersonalInfo(key, value) {
            if (!appData.personalInfo) appData.personalInfo = {};
            appData.personalInfo[key] = value;
            saveData();
        }

        function copyText(elementId) {
            const input = document.getElementById(elementId);
            if (!input) return;
            
            // Mobile-friendly copy
            input.select();
            input.setSelectionRange(0, 99999); // For mobile devices
            
            try {
                // Try modern API first, fall back to execCommand for iframes
                if (navigator.clipboard && window.isSecureContext) {
                    navigator.clipboard.writeText(input.value).then(() => {
                        showCopyFeedback(input);
                    });
                } else {
                    document.execCommand('copy');
                    showCopyFeedback(input);
                }
            } catch (err) {
                alert('複製失敗，請手動複製');
            }
        }

        function showCopyFeedback(inputElement) {
            // Visual feedback
            const originalBg = inputElement.style.backgroundColor;
            inputElement.style.backgroundColor = '#dcfce7'; // Light green
            inputElement.style.transition = 'background-color 0.3s';
            setTimeout(() => {
                inputElement.style.backgroundColor = originalBg;
            }, 500);
        }

        // --- NAVIGATION ---
        function switchTab(sectionId, btnElement) {
            activeTabId = sectionId;
            document.querySelectorAll('section').forEach(el => el.classList.add('hidden'));
            document.getElementById(sectionId).classList.remove('hidden');
            
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            if(btnElement) btnElement.classList.add('active');

            const fab = document.getElementById('fabAdd');
            if (sectionId === 'sec-itinerary' || sectionId === 'sec-memo') {
                fab.classList.remove('hidden');
                if (sectionId === 'sec-itinerary') renderItinerary();
                if (sectionId === 'sec-memo') renderMemos();
            } else {
                fab.classList.add('hidden');
            }
        }

        function handleFabClick() {
            if (activeTabId === 'sec-itinerary') {
                openEditModal(); 
            } else if (activeTabId === 'sec-memo') {
                openMemoModal(); 
            }
        }

        // --- ITINERARY LOGIC ---
        function getUniqueDays() {
            const days = [...new Set(appData.itinerary.map(item => item.day))];
            return days.sort(); 
        }

        function renderDayTabs() {
            const container = document.getElementById('dayTabs');
            container.innerHTML = '';
            const days = getUniqueDays();
            
            days.forEach(day => {
                const dayDate = appData.itinerary.find(i => i.day === day)?.date || '';
                const btn = document.createElement('button');
                btn.className = `date-tab ${day === currentDayTab ? 'active' : ''}`;
                btn.innerHTML = `${day} <small>${dayDate}</small>`;
                btn.onclick = () => {
                    currentDayTab = day;
                    renderDayTabs();
                    renderItinerary();
                };
                container.appendChild(btn);
            });
        }

        function renderItinerary() {
            renderDayTabs();
            const container = document.getElementById('itineraryContent');
            container.innerHTML = '';

            const dayItems = appData.itinerary
                .filter(i => i.day === currentDayTab)
                .sort((a, b) => a.time.localeCompare(b.time));

            if (dayItems.length === 0) {
                container.innerHTML = '<div style="text-align:center; padding:20px; color:#999;">本日無行程，按 + 新增</div>';
                return;
            }

            const list = document.createElement('div');
            list.className = 'timeline';

            dayItems.forEach(item => {
                let icon = 'fa-circle';
                if(item.type === 'food') icon = 'fa-utensils';
                if(item.type === 'transport') icon = 'fa-train-subway';
                if(item.type === 'shopping') icon = 'fa-bag-shopping';

                let actionsHtml = '';
                if (item.link) {
                    const btnLabel = item.type === 'food' ? '<i class="fa-solid fa-star"></i> 查看食記' : '<i class="fa-solid fa-map-pin"></i> 開啟地圖';
                    const btnClass = item.type === 'food' ? 'btn-food' : 'btn-map';
                    actionsHtml += `<a href="${item.link}" target="_blank" class="btn ${btnClass} btn-sm">${btnLabel}</a>`;
                }
                actionsHtml += `<button class="btn btn-sm" style="background:#666; border-color:#888;" onclick="openEditModal(${item.id})"><i class="fa-solid fa-pen"></i></button>`;

                const displayDesc = item.desc.replace(/\n/g, '<br>');
                
                let imgHtml = '';
                if (item.image) {
                    imgHtml = `<img src="${item.image}" class="timeline-img-preview" onclick="openLightbox('${item.image}')">`;
                }

                const itemHtml = `
                    <div class="timeline-item">
                        <div class="timeline-dot">
                            <i class="fa-solid ${icon}"></i>
                        </div>
                        <div class="timeline-time">${item.time}</div>
                        <div class="timeline-content">
                            <div style="font-weight:bold; font-size:1.05rem;">${item.title}</div>
                            <div style="font-size:0.9rem; color:#555; margin-top:4px; line-height:1.4;">${displayDesc}</div>
                            ${imgHtml}
                            <div class="timeline-actions">${actionsHtml}</div>
                        </div>
                    </div>
                `;
                list.innerHTML += itemHtml;
            });

            container.appendChild(list);
        }

        // --- MEMO LOGIC (Spotlight & Edit) ---
        function renderMemos() {
            const container = document.getElementById('memoContainer');
            container.innerHTML = '';
            
            if (!appData.memos || appData.memos.length === 0) {
                container.innerHTML = '<div style="color:#aaa; text-align:center;">尚無筆記，點擊右下角 + 新增</div>';
                return;
            }

            appData.memos.forEach(memo => {
                const div = document.createElement('div');
                div.className = 'memo-card';
                
                let imgHtml = '';
                if (memo.image) {
                    imgHtml = `<img src="${memo.image}" class="memo-img" onclick="openMemoSpotlight(${memo.id})">`; // Clicking image opens spotlight
                }

                div.innerHTML = `
                    <div class="memo-text">${linkify(memo.text)}</div>
                    ${imgHtml}
                    <div class="memo-actions">
                         <button class="btn btn-sm" style="background:#555;" onclick="editMemo(${memo.id})"><i class="fa-solid fa-pen"></i> 編輯</button>
                        <button class="btn btn-sm" style="background:#222;" onclick="openMemoSpotlight(${memo.id})"><i class="fa-solid fa-expand"></i> 放大</button>
                        <button class="btn btn-danger btn-sm" onclick="deleteMemo(${memo.id})"><i class="fa-solid fa-trash"></i></button>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function openMemoSpotlight(id) {
            const memo = appData.memos.find(m => m.id === id);
            if (!memo) return;

            const textContainer = document.getElementById('memoSpotlightText');
            const imgContainer = document.getElementById('memoSpotlightImg');
            
            textContainer.textContent = memo.text;
            
            if (memo.image) {
                imgContainer.src = memo.image;
                imgContainer.classList.remove('hidden');
            } else {
                imgContainer.classList.add('hidden');
            }

            document.getElementById('memoSpotlight').classList.remove('hidden');
        }

        function closeMemoSpotlight() {
            document.getElementById('memoSpotlight').classList.add('hidden');
        }

        function openMemoModal() {
            const modal = document.getElementById('memoModal');
            document.getElementById('memoId').value = '';
            document.getElementById('memoText').value = '';
            currentEditingImage = null;
            document.getElementById('memoImageInput').value = '';
            document.getElementById('memoImagePreviewContainer').style.display = 'none';
            modal.classList.remove('hidden');
        }

        function editMemo(id) {
            const memo = appData.memos.find(m => m.id === id);
            if(!memo) return;
            
            document.getElementById('memoId').value = memo.id;
            document.getElementById('memoText').value = memo.text;
            
            currentEditingImage = memo.image;
            if(memo.image) {
                document.getElementById('memoImagePreview').src = memo.image;
                document.getElementById('memoImagePreviewContainer').style.display = 'block';
            } else {
                 clearEditImage('memo');
            }
            
            document.getElementById('memoModal').classList.remove('hidden');
        }

        function saveMemo() {
            const text = document.getElementById('memoText').value;
            const idRaw = document.getElementById('memoId').value;
            
            if (!text && !currentEditingImage) return alert("請輸入內容或上傳圖片");

            if (!appData.memos) appData.memos = [];

            if (idRaw) {
                // Edit existing
                const id = parseInt(idRaw);
                const idx = appData.memos.findIndex(m => m.id === id);
                if(idx !== -1) {
                    appData.memos[idx] = { id: id, text: text, image: currentEditingImage };
                }
            } else {
                // Create new
                 appData.memos.unshift({
                    id: Date.now(),
                    text: text,
                    image: currentEditingImage
                });
            }

            // 1. Close Modal FIRST (Immediate feedback)
            closeModal('memoModal');
            
            // 2. Render UI
            renderMemos();

            // 3. Save Data in Background
            setTimeout(() => {
                saveData();
            }, 50);
        }

        function deleteMemo(id) {
            if(confirm("移除這張便條？")) {
                appData.memos = appData.memos.filter(m => m.id !== id);
                
                // 1. Render UI First
                renderMemos();

                // 2. Save Data in Background
                setTimeout(() => {
                    saveData();
                }, 50);
            }
        }

        function linkify(text) {
            const urlRegex = /(https?:\/\/[^\s]+)/g;
            return text.replace(urlRegex, function(url) {
                return `<a href="${url}" target="_blank" style="color:var(--primary); text-decoration:underline;">${url}</a>`;
            });
        }

        // --- CHECKLIST LOGIC ---
        function renderChecklist() {
            const container = document.getElementById('checklistContainer');
            container.innerHTML = '';
            appData.checklist.forEach((item, index) => {
                const div = document.createElement('div');
                div.className = `checklist-item ${item.checked ? 'checked' : ''}`;
                div.onclick = (e) => {
                    if (e.target.type !== 'checkbox') {
                        toggleCheck(index);
                    }
                };
                div.innerHTML = `
                    <input type="checkbox" ${item.checked ? 'checked' : ''} onchange="toggleCheck(${index})">
                    <span>${item.text}</span>
                    <button style="margin-left:auto; background:none; border:none; color:#999;" onclick="deleteCheck(${index}, event)">x</button>
                `;
                container.appendChild(div);
            });
        }

        function toggleCheck(index) {
            appData.checklist[index].checked = !appData.checklist[index].checked;
            
            // Render first for responsiveness
            renderChecklist();
            
            // Save in background
            setTimeout(() => {
                saveData();
            }, 50);
        }

        function addCheckItem() {
            const input = document.getElementById('newCheckItem');
            const val = input.value.trim();
            if (val) {
                appData.checklist.push({ text: val, checked: false });
                input.value = '';
                
                renderChecklist();
                
                setTimeout(() => {
                    saveData();
                }, 50);
            }
        }
        
        function deleteCheck(index, e) {
            e.stopPropagation();
            if(confirm('刪除項目？')) {
                appData.checklist.splice(index, 1);
                
                renderChecklist();
                
                setTimeout(() => {
                    saveData();
                }, 50);
            }
        }

        // --- SHARED IMAGE & TIME HELPERS ---
        function formatTimeInput(input) {
            let val = input.value.trim().replace(/[^0-9:]/g, '');
            if (val.length === 4 && !val.includes(':')) {
                val = val.substring(0, 2) + ':' + val.substring(2);
            }
            if (val.length === 5 && val.indexOf(':') === 2) {
                input.value = val;
            }
        }

        function handleImageUpload(input, type) {
            const file = input.files[0];
            if (!file) return;
            processImageFile(file, type);
        }

        window.addEventListener('paste', function(e) {
            const editModalHidden = document.getElementById('editModal').classList.contains('hidden');
            const memoModalHidden = document.getElementById('memoModal').classList.contains('hidden');

            if (editModalHidden && memoModalHidden) return;
            
            const targetType = !editModalHidden ? 'itinerary' : 'memo';

            const items = (e.clipboardData || e.originalEvent.clipboardData).items;
            for (let i = 0; i < items.length; i++) {
                if (items[i].type.indexOf('image') !== -1) {
                    const blob = items[i].getAsFile();
                    processImageFile(blob, targetType);
                    
                    // Feedback
                    const zoneId = targetType === 'itinerary' ? 'uploadDropZone' : 'memoDropZone';
                    const zone = document.getElementById(zoneId);
                    if(zone) {
                        zone.style.background = '#e0f2fe';
                        setTimeout(() => zone.style.background = '', 200);
                    }
                }
            }
        });

        function processImageFile(file, type) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.src = e.target.result;
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    
                    const MAX_WIDTH = 800;
                    const MAX_HEIGHT = 800;
                    let width = img.width;
                    let height = img.height;

                    if (width > height) {
                        if (width > MAX_WIDTH) {
                            height *= MAX_WIDTH / width;
                            width = MAX_WIDTH;
                        }
                    } else {
                        if (height > MAX_HEIGHT) {
                            width *= MAX_HEIGHT / height;
                            height = MAX_HEIGHT;
                        }
                    }

                    canvas.width = width;
                    canvas.height = height;
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    const dataUrl = canvas.toDataURL('image/jpeg', 0.7);
                    
                    currentEditingImage = dataUrl;
                    
                    if (type === 'itinerary') {
                        document.getElementById('editImagePreview').src = dataUrl;
                        document.getElementById('editImagePreviewContainer').style.display = 'block';
                    } else if (type === 'memo') {
                        document.getElementById('memoImagePreview').src = dataUrl;
                        document.getElementById('memoImagePreviewContainer').style.display = 'block';
                    }
                }
            };
            reader.readAsDataURL(file);
        }

        function clearEditImage(type) {
            currentEditingImage = null;
            if (type === 'itinerary') {
                document.getElementById('editImageInput').value = '';
                document.getElementById('editImagePreviewContainer').style.display = 'none';
            } else {
                document.getElementById('memoImageInput').value = '';
                document.getElementById('memoImagePreviewContainer').style.display = 'none';
            }
        }

        function openLightbox(src) {
            if(!src) return;
            const lb = document.getElementById('lightbox');
            const img = document.getElementById('lightboxImg');
            img.src = src;
            lb.classList.remove('hidden');
        }
        function closeLightbox() {
            document.getElementById('lightbox').classList.add('hidden');
        }

        // --- ITINERARY EDIT MODAL ---
        let editingId = null;

        function openEditModal(id = null) {
            const modal = document.getElementById('editModal');
            editingId = id;
            clearEditImage('itinerary');

            // Handle Delete Button Visibility
            const deleteBtn = document.getElementById('btnDeleteItinerary');
            if (id) {
                deleteBtn.classList.remove('hidden');
            } else {
                deleteBtn.classList.add('hidden');
            }

            if (id) {
                const item = appData.itinerary.find(i => i.id === id);
                document.getElementById('editTime').value = item.time;
                document.getElementById('editTitle').value = item.title;
                document.getElementById('editDesc').value = item.desc;
                document.getElementById('editType').value = item.type || 'activity';
                document.getElementById('editLink').value = item.link || '';
                
                if (item.image) {
                    currentEditingImage = item.image;
                    document.getElementById('editImagePreview').src = item.image;
                    document.getElementById('editImagePreviewContainer').style.display = 'block';
                }
            } else {
                document.getElementById('editTime').value = '12:00';
                document.getElementById('editTitle').value = '';
                document.getElementById('editDesc').value = '';
                document.getElementById('editType').value = 'activity';
                document.getElementById('editLink').value = '';
            }
            modal.classList.remove('hidden');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.add('hidden');
            editingId = null;
        }

        function saveItineraryItem() {
            const timeRaw = document.getElementById('editTime').value;
            let time = timeRaw;
            if (timeRaw.length === 4 && !timeRaw.includes(':')) {
                time = timeRaw.substring(0, 2) + ':' + timeRaw.substring(2);
            }
            
            const title = document.getElementById('editTitle').value;
            const desc = document.getElementById('editDesc').value;
            const type = document.getElementById('editType').value;
            const link = document.getElementById('editLink').value;

            if (!title) return alert('請輸入標題');

            if (editingId) {
                const idx = appData.itinerary.findIndex(i => i.id === editingId);
                if (idx !== -1) {
                    appData.itinerary[idx] = { 
                        ...appData.itinerary[idx], 
                        time, title, desc, type, link,
                        image: currentEditingImage 
                    };
                }
            } else {
                const newId = Date.now();
                const currentDayObj = appData.itinerary.find(i => i.day === currentDayTab);
                const dateStr = currentDayObj ? currentDayObj.date : '12/11';
                
                appData.itinerary.push({
                    id: newId,
                    day: currentDayTab,
                    date: dateStr,
                    time, title, desc, type, link,
                    image: currentEditingImage 
                });
            }

            // 1. Close Modal FIRST (Immediate feedback)
            closeModal('editModal');
            
            // 2. Render UI (Immediate feedback)
            renderItinerary();

            // 3. Save Data in Background (Avoid UI freeze)
            setTimeout(() => {
                saveData();
            }, 50);
        }

        function deleteItem() {
            if (editingId && confirm('確定刪除此行程？')) {
                appData.itinerary = appData.itinerary.filter(i => i.id !== editingId);
                
                // 1. Close Modal FIRST
                closeModal('editModal');
                
                // 2. Render UI
                renderItinerary();

                // 3. Save Data in Background
                setTimeout(() => {
                    saveData();
                }, 50);
            }
        }

        // --- WEATHER LOGIC ---
        async function fetchWeather() {
            const display = document.getElementById('weatherDisplay');
            const lat = 35.6895;
            const lon = 139.6917;
            
            try {
                const response = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true&daily=weathercode,temperature_2m_max,temperature_2m_min,precipitation_probability_max&timezone=Asia%2FTokyo&forecast_days=3`);
                const data = await response.json();
                const daily = data.daily;
                
                const getFormattedDate = (offset) => {
                    const d = new Date();
                    d.setDate(d.getDate() + offset);
                    return d.getDate() + '/' + (d.getMonth() + 1);
                };

                let html = `<div style="margin-bottom:10px; font-weight:bold; border-bottom:1px solid rgba(255,255,255,0.3); padding-bottom:5px;">東京 3 日預報</div>`;

                for(let i=0; i<3; i++) {
                    const code = daily.weathercode[i];
                    let wDesc = "晴/多雲";
                    let wIcon = "fa-sun";
                    if(code > 3) { wDesc = "陰天"; wIcon = "fa-cloud"; }
                    if(code > 50) { wDesc = "有雨"; wIcon = "fa-umbrella"; }
                    if(code > 70) { wDesc = "大雪/雨"; wIcon = "fa-snowflake"; }

                    const dateStr = getFormattedDate(i);

                    html += `
                        <div class="weather-day-row">
                            <div style="flex:1;">
                                <div style="font-size:0.95rem;">${dateStr}</div>
                            </div>
                            <div style="flex:1; text-align:center;"><i class="fa-solid ${wIcon}"></i> ${wDesc}</div>
                            <div style="flex:1; text-align:right;">
                                <span class="temp-high"><i class="fa-solid fa-sun" style="font-size:0.7em;"></i> ${daily.temperature_2m_max[i]}°</span> 
                                <span class="temp-low" style="margin-left:5px;"><i class="fa-solid fa-moon" style="font-size:0.7em;"></i> ${daily.temperature_2m_min[i]}°</span>
                            </div>
                        </div>
                        <div style="font-size:0.75rem; text-align:right; opacity:0.8; margin-top:-4px;">降雨機率: ${daily.precipitation_probability_max[i]}%</div>
                    `;
                }
                display.innerHTML = html;
            } catch (e) {
                console.error(e);
                display.innerHTML = '<p>無法載入詳細預報。<br>請點擊下方按鈕查看氣象廳。</p>';
            }
        }

        // --- INIT ---
        window.onload = function() {
            renderChecklist();
            renderMemos(); 
            fetchWeather();
            renderItinerary();
            renderPersonalInfo(); // Initialize new section
            switchTab('sec-booking', document.querySelector('.nav-item.active'));
        };

    </script>
</body>
</html>
